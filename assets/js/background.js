Math.inInterval=Math.inInterval||function(a,b,c){return Math.min(c,Math.max(b,a))},window.lang={get:function(a){return chrome.i18n.getMessage(a)}},window._helper={pack:function(a){return JSON.stringify(a)},unpack:function(a){try{return JSON.parse(a)}catch(b){return null}},isNumber:function(a){return!isNaN(parseFloat(a))&&isFinite(a)&&!this.isString&&!this.isBoolean&&!this.isObject&&!this.isArray},isArray:function(a){return!this.isNull(a)&&"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return!this.isEmpty(a)&&"object"==typeof a},isBoolean:function(a){return"boolean"==typeof a},isString:function(a){return"string"==typeof a},isNull:function(a){return void 0===a||null===a},isEmpty:function(a){return this.isNull(a)||"undefined"!=typeof a.length&&0==a.length}},window.storage={get:function(a,b,c){var d="undefined"==typeof localStorage[a]||"null"==typeof localStorage[a]?_helper.pack(b):localStorage[a];switch(d=null==_helper.unpack(d)?b:_helper.unpack(d),c){case"number":(_helper.isNull(d)||_helper.isEmpty(d))&&(d=0),_helper.isNumber(d)||(d=parseFloat(d)),this.set(a,d);break;case"boolean":d=_helper.isBoolean(d)?d:!!b,this.set(a,d);break;case"object":case"array":d=_helper.isObject(d)||_helper.isArray(d)?d:"array"==c?[]:{},this.set(a,d);break;default:this.set(a,d)}return d},set:function(a,b){b=_helper.pack(b),localStorage[a]=b}},window.options={get refreshInterval(){return storage.get("refresh_interval",.1666666666666667,"number")},get audioOn(){return storage.get("audioOn",!0,"boolean")},get showContext(){return storage.get("showContext",!0,"boolean")},get refreshSoundFile(){return storage.get("refresh_sound_file","assets/sound/click.ogg","string")},get urlForum(){return storage.get("url_forum","://demiart.ru/forum/","string")},get refreshDate(){return storage.get("refresh_date",(new Date).getFullYear(),"number")},get viewTab(){return storage.get("viewtab",!0,"boolean")},get sounVolume(){return storage.get("sounVolume",.5,"number")},get favicon(){return storage.get("favicon",!0,"boolean")},get demiColor(){return storage.get("demiColor",!0,"boolean")},get protocolForum(){return storage.get("protocol","https","string")},set refreshInterval(a){storage.set("refresh_interval",a)},set audioOn(a){storage.set("audioOn",a)},set showContext(a){storage.set("showContext",a)},set refreshSoundFile(a){storage.set("refresh_sound_file",a)},set urlForum(a){storage.set("url_forum",a)},set refreshDate(a){storage.set("refresh_date",a)},set viewTab(a){storage.set("viewtab",a)},set sounVolume(a){a=Math.inInterval(a,0,1),storage.set("sounVolume",a)},set favicon(a){storage.set("favicon",a)},set demiColor(a){storage.set("demiColor",a)},set protocolForum(a){storage.set("protocol",a)}},window.soundList=[{name:lang.get("defaulSound"),value:"assets/sound/click.ogg",id:"click"},{name:lang.get("messengerSound"),value:"assets/sound/ding.ogg",id:"ding"},{name:lang.get("alarmSound"),value:"assets/sound/alert-0000.ogg",id:"alert-0000"},{name:lang.get("water1Sound"),value:"assets/sound/water-0000.ogg",id:"water-0000"},{name:lang.get("water2Sound"),value:"assets/sound/water-0001.ogg",id:"water-0001"},{name:lang.get("water3Sound"),value:"assets/sound/water-0002.ogg",id:"water-0002"},{name:lang.get("android1Sound"),value:"assets/sound/android-0000.ogg",id:"android-0000"},{name:lang.get("android2Sound"),value:"assets/sound/android-0001.ogg",id:"android-0001"},{name:lang.get("android3Sound"),value:"assets/sound/android-0002.ogg",id:"android-0002"},{name:lang.get("android4Sound"),value:"assets/sound/android-0003.ogg",id:"android-0003"},{name:lang.get("android5Sound"),value:"assets/sound/animal-0000.ogg",id:"animal-0000"},{name:lang.get("kickSound"),value:"assets/sound/kick-0000.ogg",id:"kick-0000"},{name:lang.get("laser1Sound"),value:"assets/sound/lazer-0000.ogg",id:"lazer-0000"},{name:lang.get("laser2Sound"),value:"assets/sound/lazer-0001.ogg",id:"lazer-0001"},{name:lang.get("sequence1Sound"),value:"assets/sound/sequence-0000.ogg",id:"sequence-0000"},{name:lang.get("sequence2Sound"),value:"assets/sound/sequence-0001.ogg",id:"sequence-0001"},{name:lang.get("sundry1Sound"),value:"assets/sound/misc-0000.ogg",id:"misc-0000"},{name:lang.get("sundry2Sound"),value:"assets/sound/misc-0001.ogg",id:"misc-0001"},{name:lang.get("sundry3Sound"),value:"assets/sound/misc-0002.ogg",id:"misc-0002"},{name:lang.get("sundry4Sound"),value:"assets/sound/animal-0001.ogg",id:"animal-0001"},{name:lang.get("chat1Sound"),value:"assets/sound/sound_1.ogg",id:"sound_1"},{name:lang.get("chat2Sound"),value:"assets/sound/sound_2.ogg",id:"sound_2"},{name:lang.get("chat3Sound"),value:"assets/sound/sound_3.ogg",id:"sound_3"},{name:lang.get("chat4Sound"),value:"assets/sound/sound_4.ogg",id:"sound_4"},{name:lang.get("chat5Sound"),value:"assets/sound/sound_5.ogg",id:"sound_5"},{name:lang.get("chat6Sound"),value:"assets/sound/sound_6.ogg",id:"sound_6"}],window.urlList=[{optiongroup:"Форум",options:[{name:"Главная страница форума",value:"://demiart.ru/forum/index.php"},{name:"Раздел «Photoshop»",value:"://demiart.ru/forum/index.php?act=SC&c=2"},{name:"Раздел «Art»",value:"://demiart.ru/forum/index.php?act=SC&c=3"},{name:"Раздел «Фото»",value:"://demiart.ru/forum/index.php?act=SC&c=11"},{name:"Раздел «Креатив и Созидание»",value:"://demiart.ru/forum/index.php?act=SC&c=9"},{name:"Раздел «Векторные редакторы»",value:"://demiart.ru/forum/index.php?act=SC&c=8"},{name:"Раздел «Flash»",value:"://demiart.ru/forum/index.php?act=SC&c=13"},{name:"Раздел «Handmade. Декоративно-прикладное искусство.»",value:"://demiart.ru/forum/index.php?act=SC&c=18"},{name:"Раздел «Изо»",value:"://demiart.ru/forum/index.php?act=SC&c=15"},{name:"Раздел «3D редакторы»",value:"://demiart.ru/forum/index.php?act=SC&c=10"},{name:"Раздел «Обработка и создание Видео»",value:"://demiart.ru/forum/index.php?act=SC&c=6"},{name:"Раздел «Фракталы»",value:"://demiart.ru/forum/index.php?act=SC&c=19"},{name:"Раздел «Painter и Планшеты»",value:"://demiart.ru/forum/index.php?act=SC&c=17"},{name:"Раздел «Музыка»",value:"://demiart.ru/forum/index.php?act=SC&c=14"},{name:"Раздел «Литература»",value:"://demiart.ru/forum/index.php?act=SC&c=16"},{name:"Раздел «Компьютерные программы»",value:"://demiart.ru/forum/index.php?act=SC&c=20"},{name:"Раздел «Работа»",value:"://demiart.ru/forum/index.php?act=SC&c=21"},{name:"Раздел «Соревнования»",value:"://demiart.ru/forum/index.php?act=SC&c=7"},{name:"Раздел «НАШЕ ВСЁ»",value:"://demiart.ru/forum/index.php?act=SC&c=4"}]},{optiongroup:"Гильдии",options:[{name:"Главная страница Гильдий",value:"://demiart.ru/forum/index.php?act=SC&c=12"},{name:"Форум гильдии Темных",value:"://demiart.ru/forum/index.php?showforum=53"},{name:"Форум гильдии Фантазеров",value:"://demiart.ru/forum/index.php?showforum=56"},{name:"Форум гильдии Фотографов",value:"://demiart.ru/forum/index.php?showforum=60"},{name:"Форум гильдии новичков",value:"://demiart.ru/forum/index.php?showforum=62"},{name:"Форум гильдии Светлых",value:"://demiart.ru/forum/index.php?showforum=63"},{name:"Форум гильдии Вампиров",value:"://demiart.ru/forum/index.php?showforum=68"},{name:"Форум гильдии мир анимэ и манги",value:"://demiart.ru/forum/index.php?showforum=69"},{name:"Форум гильдии Художников",value:"://demiart.ru/forum/index.php?showforum=74"},{name:"Форум гильдии Живописцев",value:"://demiart.ru/forum/index.php?showforum=77"},{name:"Форум гильдии бездельников",value:"://demiart.ru/forum/index.php?showforum=79"},{name:"Форум гильдии Графиков",value:"://demiart.ru/forum/index.php?showforum=84"},{name:"Форум гильдии Фотоарта",value:"://demiart.ru/forum/index.php?showforum=89"},{name:"Форум гильдии Векторщиков",value:"://demiart.ru/forum/index.php?showforum=92"},{name:"Форум гильдии NuArt",value:"://demiart.ru/forum/index.php?showforum=112"},{name:"Форум гильдии Мафии",value:"://demiart.ru/forum/index.php?showforum=114"},{name:"Форум гильдии Трёхмерщиков",value:"://demiart.ru/forum/index.php?showforum=115"},{name:"Форум гильдии Оригиналов",value:"://demiart.ru/forum/index.php?showforum=116"},{name:"Форум гильдии Фрактальщиков",value:"://demiart.ru/forum/index.php?showforum=122"},{name:"Форум гильдии Комиксов",value:"://demiart.ru/forum/index.php?showforum=123"},{name:"Форум гильдии Анималистов",value:"://demiart.ru/forum/index.php?showforum=125"},{name:"Форум гильдии Лингвистов",value:"://demiart.ru/forum/index.php?showforum=126"}]}],function(){var a,b,c,d,e,f,g="undefined"!=typeof chrome?chrome.extension.getBackgroundPage():opera.extension.bgProcess,h=(chrome.i18n.getMessage("@@extension_id"),options.urlForum),i="http://demicolor.demiart.ru/",j="http://morgoth.ru/",k="http://www.youtube.com/c/demiartru",l=new Audio(options.refreshSoundFile),m=0,n=0,o=0,p=options.protocolForum+"://demiart.ru/forum/",q=new Image,r=new Image,s=new Image,t=document.createElement("canvas"),u=document.createElement("canvas"),v=u.getContext("2d"),w=t.getContext("2d"),x=window.devicePixelRatio||1,y={width:7,height:9,font:"bold "+10*x+"px arial",colour:"#ffffff",background:"#F03D25",size:16},z=void 0,A=function(a){chrome.tabs.insertCSS(a,{file:"assets/css/count-msg.css"},function(){chrome.tabs.executeScript(a,{file:"assets/js/count-msg.js"})})},B=function(a){chrome.tabs.insertCSS(a,{file:"assets/css/ddc.css"},function(){chrome.tabs.executeScript(a,{file:"assets/js/ddc.js"})})},C=function(){clearTimeout(m),n=n>35?0:n;var a=19*n,b={};w.drawImage(r,a,0,19,19,0,0,19,19),b[19]=w.getImageData(0,0,19,19),chrome.browserAction.setIcon({imageData:b}),++n,m=setTimeout(C,60)},D=function(){clearTimeout(m),chrome.browserAction.setIcon({path:"assets/images/icon19.png"})},E=function(a){v.clearRect(0,0,16,16),v.drawImage(s,0,0,16,16,0,0,16,16);if(a=parseInt(a)){a=a>99?99:a;var b,c=(a+"").length-1,d=y.width*x+6*x*c,e=y.height*x,f=y.size-e,g=y.size-d-x,h=b=16*x,i=2*x;v.font=y.font,v.fillStyle=v.strokeStyle="#F03D25",v.lineWidth=1,v.beginPath(),v.moveTo(g+i,f),v.quadraticCurveTo(g,f,g,f+i),v.lineTo(g,h-i),v.quadraticCurveTo(g,h,g+i,h),v.lineTo(b-i,h),v.quadraticCurveTo(b,h,b,h-i),v.lineTo(b,f+i),v.quadraticCurveTo(b,f,b-i,f),v.closePath(),v.fill(),v.beginPath(),v.strokeStyle="rgba(0,0,0,0.3)",v.moveTo(g+i/2,h),v.lineTo(b-i/2,h),v.stroke(),v.fillStyle=y.colour,v.textAlign="right",v.textBaseline="top",v.fillText(a+"",2===x?29:15,6*x)}return u.toDataURL()},F=function(){b&&clearTimeout(b),chrome.contextMenus.removeAll(),h=options.urlForum,options.refreshInterval||(b=setTimeout(R,6e4*options.refreshInterval)),chrome.tabs.query({},function(a){for(var b=0;b<a.length;++b){var c=a[b].id,d=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;if(d.test(a[b].url))if(chrome.tabs.sendMessage(c,{ddc:o,url:p,def:options.protocolForum+options.urlForum,message:"ddc"}),options.favicon){var e=E(o);chrome.tabs.sendMessage(c,{data:e,message:"favicon"})}else chrome.tabs.sendMessage(c,{data:"/favicon.ico",message:"favicon"})}}),Q()},G=function(g,l){switch(g.menuItemId){case c:b&&clearTimeout(b),b=setTimeout(function(){R()},5e3),void 0!=a?chrome.tabs.get(a.id,I):chrome.tabs.create({url:options.protocolForum+h,active:!0},H);break;case e:chrome.tabs.create({url:i,active:!0},null);break;case d:chrome.tabs.create({url:j,active:!0},null);break;case f:chrome.tabs.create({url:k,active:!0},null)}},H=function(b){a=b},I=function(b){if(a=b,b&&options.viewTab){var c=/(https?:\/\/demiart.ru\/forum)/gi;if(c.test(b.url))try{chrome.tabs.update(b.id,{url:options.protocolForum+h,active:!0},H)}catch(d){chrome.tabs.create({url:options.protocolForum+h,active:!0},H)}else chrome.tabs.create({url:options.protocolForum+h,active:!0},H)}else chrome.tabs.create({url:options.protocolForum+h,active:!0},H)},J=function(a,b){options.showContext=a.checked,chrome.contextMenus.removeAll(),Q()},K=function(a,b){options.audioOn=a.checked},L=function(a,b){options.refreshSoundFile="assets/sound/"+a.menuItemId+".ogg",l.src=options.refreshSoundFile,l.volume=options.sounVolume,l.play()},M=function(a,b){options.sounVolume=a.menuItemId,l.src=options.refreshSoundFile,l.volume=options.sounVolume,l.play()},N=function(a,b){options.viewTab=a.checked},O=function(a,b){options.demiColor=a.checked},P=function(a,b){options.favicon=a.checked,F(),chrome.tabs.query({},function(a){for(var b=0,c=0;c<a.length;++c){var d=a[c].id,e=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;if(e.test(a[c].url))if(++b,chrome.tabs.sendMessage(d,{ddc:o,url:p,def:options.protocolForum+options.urlForum,message:"ddc"}),options.favicon){var f=E(o);chrome.tabs.sendMessage(d,{data:f,message:"favicon"})}else chrome.tabs.sendMessage(d,{data:"/favicon.ico",message:"favicon"})}})},Q=function(){var a=options.showContext?"all":"browser_action",b=chrome.contextMenus.create({title:"Demiart Discussion Count",contexts:[a]});chrome.contextMenus.create({title:lang.get("refresh"),contexts:[a],parentId:b,onclick:R}),chrome.contextMenus.create({type:"separator",title:"",contexts:[a],parentId:b}),c=chrome.contextMenus.create({title:lang.get("goTo")+" "+lang.get("forum"),contexts:[a],parentId:b,onclick:G}),e=chrome.contextMenus.create({title:lang.get("goTo")+" DemiColor",contexts:[a],parentId:b,onclick:G}),d=chrome.contextMenus.create({title:lang.get("goTo")+" "+lang.get("hosting"),contexts:[a],parentId:b,onclick:G}),f=chrome.contextMenus.create({title:lang.get("goTo")+" "+lang.get("chanel"),contexts:[a],parentId:b,onclick:G}),chrome.contextMenus.create({type:"separator",title:"",contexts:[a],parentId:b}),chrome.contextMenus.create({title:lang.get("contextMenu"),contexts:[a],type:"checkbox",checked:options.showContext,parentId:b,onclick:J}),chrome.contextMenus.create({title:lang.get("soundAlarm"),type:"checkbox",checked:options.audioOn,contexts:[a],parentId:b,onclick:K}),chrome.contextMenus.create({title:lang.get("openTab"),type:"checkbox",checked:options.viewTab,contexts:[a],parentId:b,onclick:N}),chrome.contextMenus.create({title:lang.get("demiColor"),type:"checkbox",checked:options.demiColor,contexts:[a],parentId:b,onclick:O}),chrome.contextMenus.create({title:lang.get("refreshFavicon"),type:"checkbox",checked:options.favicon,contexts:[a],parentId:b,onclick:P}),chrome.contextMenus.create({type:"separator",title:"",contexts:[a],parentId:b});for(var g=chrome.contextMenus.create({title:lang.get("changeSound"),contexts:["browser_action"],type:"normal",parentId:b}),h=chrome.contextMenus.create({title:lang.get("fileSound"),contexts:["browser_action"],type:"normal",parentId:g}),i=chrome.contextMenus.create({title:lang.get("volumeSound"),contexts:["browser_action"],type:"normal",parentId:g}),j=0;j<soundList.length;++j)chrome.contextMenus.create({title:soundList[j].name,id:soundList[j].id,contexts:["browser_action"],type:"radio",checked:options.refreshSoundFile=="assets/"+soundList[j].id+".ogg",parentId:h,onclick:L});for(var k=0;k<1;)k+=.05,k=Number(k.toFixed(3)),chrome.contextMenus.create({title:Math.round(100*k)+"%",id:String(k),contexts:["browser_action"],type:"radio",checked:options.sounVolume==k,parentId:i,onclick:M});options.showContext&&(chrome.contextMenus.create({title:"separator",contexts:["page"],parentId:b,type:"separator"}),chrome.contextMenus.create({title:lang.get("settings"),contexts:["page"],parentId:b,onclick:function(){chrome.runtime.openOptionsPage()}}))},R=function(){b&&clearTimeout(b);var a=new XMLHttpRequest;a.open("GET",options.protocolForum+"://demiart.ru/forum/index.php?act=ST&CODE=discuss&_="+(new Date).getTime()),a.send(""),C(),a.onreadystatechange=function(){if(4==this.readyState){if(D(),options.refreshInterval&&(b=setTimeout(R,6e4*options.refreshInterval)),200!=a.status)return void chrome.browserAction.setBadgeText({text:"Error"});var d=_helper.unpack(a.response)||{count:0,href:options.protocolForum+"://demiart.ru/forum/"},e=parseInt(d.count)||0;h=d.href.replace(/^https?/,""),"://demiart.ru/forum/"==d.href&&(h=options.urlForum);var f=a.getResponseHeader("Date");if(options.refreshDate=parseInt(f.split(" ")[3]),e){chrome.browserAction.getBadgeText({},function(a){a=parseInt(a)||0,a<e&&options.audioOn&&(l.src=options.refreshSoundFile,l.volume=options.sounVolume,l.play())});var g=lang.get("comments").replace(/\*ddc\*/,String(e)),i=lang.get("commentsmenu").replace(/\*ddc\*/,String(e));chrome.browserAction.setBadgeText({text:String(e)}),chrome.browserAction.setTitle({title:g}),chrome.contextMenus.update(c,{title:i})}else chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setTitle({title:lang.get("name")}),chrome.contextMenus.update(c,{title:lang.get("goTo")+" "+lang.get("forum")});o=e,p=options.protocolForum+h,chrome.tabs.query({},function(a){for(var b=0,c=0;c<a.length;++c){var d=a[c].id,e=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;if(e.test(a[c].url))if(++b,chrome.tabs.sendMessage(d,{ddc:o,url:p,def:options.urlForum,message:"ddc"}),"true"==localStorage.favicon){var f=E(o);chrome.tabs.sendMessage(d,{data:f,message:"favicon"})}else chrome.tabs.sendMessage(d,{data:"/favicon.ico",message:"favicon"})}})}}};q.src="assets/images/fi.png",r.src="assets/images/ld.png",s.src="assets/images/favicon.png",t.width=19,u.width=16,t.height=19,u.height=16,document.body.appendChild(t),document.body.appendChild(u),l.volume=options.sounVolume,chrome.browserAction.setBadgeBackgroundColor({color:"#d22d2d"}),chrome.tabs.onUpdated.addListener(function(a,c,d){z=c.status;var e=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi,f=/(UserCP)/gi;"loading"==c.status&&options.demiColor&&e.test(d.url)&&0==f.test(d.url)&&B(d.id),e=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi,"loading"==c.status&&e.test(d.url)&&(A(d.id),setTimeout(function(){chrome.tabs.sendMessage(d.id,{ddc:o,url:p,def:options.protocolForum+options.urlForum,message:"ddc"}),"true"==localStorage.favicon?chrome.tabs.sendMessage(d.id,{data:E(o),message:"favicon"}):chrome.tabs.sendMessage(d.id,{data:"/favicon.ico",message:"favicon"})},1500),D(),b&&clearTimeout(b),b=setTimeout(R,2500))}),chrome.commands.onCommand.addListener(function(b){switch(b){case"activate_tab_demi":void 0!=a?chrome.tabs.query({},function(b){for(var c=!1,d=0;d<b.length;++d){var e=b[d],f=/(httpS?:\/\/demiart.ru\/forum)/gi;if(a.id==e.id&&f.test(e.url)){chrome.tabs.update(e.id,{selected:!0},H),c=!0;break}}c||chrome.tabs.create({url:options.protocolForum+options.urlForum,active:!0},H)}):chrome.tabs.create({url:options.protocolForum+options.urlForum,active:!0},H)}}),chrome.browserAction.onClicked.addListener(function(b){void 0!=a&&"true"==localStorage.viewtab?chrome.tabs.query({},function(b){for(var c=0;c<b.length;++c){var d=/(https?:\/\/demiart.ru\/forum)/gi,e=b[c];if(d.test(e.url)&&a.id==e.id)return void chrome.tabs.update(a.id,{url:options.protocolForum+h,active:!0},H)}chrome.tabs.create({url:options.protocolForum+h,active:!0},H)}):chrome.tabs.create({url:options.protocolForum+h,active:!0},H)}),chrome.tabs.query({},function(a){for(var b=0;b<a.length;++b){var c=a[b].id,d=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;d.test(a[b].url)&&(A(a[b].id),setTimeout(function(){chrome.tabs.sendMessage(c,{data:"/favicon.ico",message:"favicon"})},100))}}),Q(),g.demiColorVer="1.0.2",g.resetOptions=F,b=setTimeout(function(){R()},1e3)}();