window.HELPER={pack:function(t){return JSON.stringify(t)},unpack:function(t){try{return JSON.parse(t)}catch(t){return null}},isNumber:function(t){return!isNaN(parseFloat(t))&&isFinite(t)&&!this.isString&&!this.isBoolean&&!this.isObject&&!this.isArray},isArray:function(t){return!this.isNull(t)&&"[object Array]"===Object.prototype.toString.call(t)},isObject:function(t){return!this.isEmpty(t)&&"object"==typeof t},isBoolean:function(t){return"boolean"==typeof t},isString:function(t){return"string"==typeof t},isNull:function(t){return void 0===t||null===t},isEmpty:function(t){return this.isNull(t)||void 0!==t.length&&0==t.length}},window.OPTIONS={get:function(t,e,n){var o=void 0===localStorage[t]||"null"==typeof localStorage[t]?HELPER.pack(e):localStorage[t];switch(o=null==HELPER.unpack(o)?e:HELPER.unpack(o),n){case"number":(HELPER.isNull(o)||HELPER.isEmpty(o))&&(o=0),HELPER.isNumber(o)||(o=parseFloat(o)),this.set(t,o);break;case"boolean":o=HELPER.isBoolean(o)?o:!!e,this.set(t,o);break;case"object":case"array":o=HELPER.isObject(o)||HELPER.isArray(o)?o:"array"==n?[]:{},this.set(t,o);break;default:this.set(t,o)}return o},set:function(t,e){e=HELPER.pack(e),localStorage[t]=e}},function(t,e,n){var o=OPTIONS.get("INTERVAL",.1666666666666667,"number"),i=OPTIONS.get("AUDIO_CHECKBOX",!0,"boolean"),r=OPTIONS.get("SOUNDS","/sound/alarm0.ogg","string"),s=OPTIONS.get("AUDIO_VOLUME",.5,"number"),a=OPTIONS.get("TAB_CHECKBOX",!0,"boolean"),c=OPTIONS.get("DEMICOLOR_CHECKBOX",!0,"boolean"),u="https://demiart.ru/forum/",l=null,d=0,g=0,f=0,m=0,p=e.createElement("canvas").getContext("2d"),h=e.createElement("img");p.canvas.width=16,p.canvas.height=16,h.width=16,h.height=16,h.src=t.runtime.getURL("/images/favicon.png");const b="https://demiart.ru/forum/",O=t.runtime.getURL("/images/icon19.png"),T=t.runtime.getURL("/images/fi.png"),E=(t.i18n.getMessage("@@extension_id"),new Audio),I=function(t){clearTimeout(m),m=setTimeout(S,100)},S=async function(){let e=n.navigator.onLine;if(clearTimeout(m),t.browserAction.setIcon({path:O}),o&&e){t.browserAction.setIcon({path:T});let n="https://demiart.ru/forum/index.php?act=ST&CODE=discuss&_="+(new Date).getTime();fetch(n).then(function(n){n.json().then(function(e){e.year=new Date(n.headers.get("date")).getFullYear(),OPTIONS.set("YEAR",e.year),u=e.href,t.browserAction.setIcon({path:O}),t.browserAction.setBadgeText({text:e.count?String(e.count):""}),e.count>d&&i&&(E.volume=parseFloat(s),E.currentTime=0,E.src=t.runtime.getURL(r),E.play()),d=e.count,y()}).catch(function(){u=b,d=0,t.browserAction.setIcon({path:O}),t.browserAction.setBadgeText({text:e?"Error":"Off"}),y()}),t.browserAction.setIcon({path:O}),m=setTimeout(S,6e4*o)}).catch(function(){u=b,d=0,t.browserAction.setIcon({path:O}),t.browserAction.setBadgeText({text:e?"Error":"Off"}),y(),m=setTimeout(S,6e4*o)})}else{let n=o||.1;u=b,d=0,t.browserAction.setIcon({path:O}),t.browserAction.setBadgeText({text:e?"":"Off"}),y(),m=setTimeout(S,6e4*n)}},x=function(){void 0!=l&&a?t.tabs.query({},function(e){for(var n=0;n<e.length;++n){var o=e[n];if(/^(https?:\/\/demiart.ru\/forum)/gi.test(o.url)&&l.id==o.id)return void t.tabs.update(l.id,{url:u,active:!0},v)}t.tabs.create({url:u,active:!0},v)}):t.tabs.create({url:u,active:!0},v)},v=function(t){l=t},M=function(e){t.tabs.insertCSS(e,{file:"/css/messages.css"},function(){}),t.tabs.executeScript(e,{file:"/js/messages.js"},function(){})},y=function(){t.tabs.query({},function(e){for(let n=0;n<e.length;++n){let o=e[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(e[n].url)&&t.tabs.sendMessage(o,{idtab:o,ddc:d,url:u,def:b,favicon:w(),message:"ddc",demicolor:c})}}),g&&t.contextMenus.update(g,{title:d<=0?t.i18n.getMessage("forum"):t.i18n.getMessage("comments").replace("*ddc*",d)})},w=function(){let t=String(d>99?"+99":d)+"";if(p.clearRect(0,0,16,16),p.drawImage(h,0,0,16,16,0,0,16,16),d){var e,o=n.devicePixelRatio||1,i=16-9*o,r=16-(7*o+6*o*(t.length-1))-o,s=e=16*o,a=2*o;p.font="bold "+8*o+"px arial",p.fillStyle=p.strokeStyle="#F03D25",p.lineWidth=1,p.beginPath(),p.moveTo(r+a,i),p.quadraticCurveTo(r,i,r,i+a),p.lineTo(r,s-a),p.quadraticCurveTo(r,s,r+a,s),p.lineTo(e-a,s),p.quadraticCurveTo(e,s,e,s-a),p.lineTo(e,i+a),p.quadraticCurveTo(e,i,e-a,i),p.closePath(),p.fill(),p.beginPath(),p.strokeStyle="rgba(0,0,0,0.3)",p.moveTo(r+a/2,s),p.lineTo(e-a/2,s),p.stroke(),p.fillStyle="#ffffff",p.textAlign="right",p.textBaseline="top",p.fillText(t+"",2===o?29:15,6*o)}return p.canvas.toDataURL()};t.runtime.onMessage.addListener(function(e,n,u){return setTimeout(function(){switch(u({status:!0}),clearTimeout(f),e.message){case"OPTIONS":o=OPTIONS.get("INTERVAL",.16667,"number"),i=OPTIONS.get("AUDIO_CHECKBOX",!0,"boolean"),r=OPTIONS.get("SOUNDS","/sound/alarm0.ogg","string"),s=OPTIONS.get("AUDIO_VOLUME",.5,"number"),a=OPTIONS.get("TAB_CHECKBOX",!0,"boolean"),c=OPTIONS.get("DEMICOLOR_CHECKBOX",!0,"boolean"),f=setTimeout(()=>{E.volume=parseFloat(s),E.currentTime=0,E.src=t.runtime.getURL(r)},1),S(),t.tabs.query({},function(e){for(let n=0;n<e.length;++n){let o=e[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(e[n].url)&&setTimeout(function(){t.tabs.sendMessage(o,{demicolor:c,message:"demicolor"})},100)}});break;case"FETCH":S()}},1),!0}),t.browserAction.onClicked.addListener(function(t){x()}),t.tabs.onUpdated.addListener(function(t,e,n){var o=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;new RegExp("showuser","ig");switch(e.status){case"loading":o.test(n.url)&&(M(n.id),S())}o=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi,"loading"==e.status&&o.test(n.url)}),t.tabs.query({},function(e){for(let n=0;n<e.length;++n){let o=e[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(e[n].url)&&(M(e[n].id),setTimeout(function(){t.tabs.sendMessage(o,{idtab:o,url:u,def:b,ddc:d,favicon:w(),demicolor:c,message:"ddc"})},100))}}),t.browserAction.setIcon({path:O}),t.browserAction.setBadgeBackgroundColor({color:"#d22d2d"}),n.addEventListener("online",I),n.addEventListener("offline",I),E.controls=!1,E.style.display="none",E.crossOrigin="anonymous",E.preload="none",E.src=t.runtime.getURL(r),S(),ddcMenu=t.contextMenus.create({title:"Demiart DDC",contexts:["all"]}),g=t.contextMenus.create({title:t.i18n.getMessage("forum"),contexts:["all"],parentId:ddcMenu,onclick:x}),t.contextMenus.create({title:t.i18n.getMessage("hosting"),contexts:["all"],parentId:ddcMenu,onclick:function(){t.tabs.create({url:"https://morgoth.ru/",active:!0},function(t){})}}),t.contextMenus.create({title:t.i18n.getMessage("youtube"),contexts:["all"],parentId:ddcMenu,onclick:function(){t.tabs.create({url:"https://www.youtube.com/c/demiartru",active:!0},function(t){})}}),t.contextMenus.create({title:t.i18n.getMessage("demicolor"),contexts:["all"],parentId:ddcMenu,onclick:function(){t.tabs.create({url:"https://demicolor.demiart.ru/",active:!0},function(t){})}}),t.contextMenus.create({title:"",contexts:["all"],parentId:ddcMenu,type:"separator"}),t.contextMenus.create({title:t.i18n.getMessage("refresh"),contexts:["all"],parentId:ddcMenu,onclick:S}),t.contextMenus.create({title:"",contexts:["all"],parentId:ddcMenu,type:"separator"}),t.contextMenus.create({title:t.i18n.getMessage("settings"),contexts:["all"],parentId:ddcMenu,onclick:function(){t.runtime.openOptionsPage()}})}(chrome,document,window);