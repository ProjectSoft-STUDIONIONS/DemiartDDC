window.HELPER={pack:function(e){return JSON.stringify(e)},unpack:function(e){try{return JSON.parse(e)}catch(e){return null}},isNumber:function(e){return!isNaN(parseFloat(e))&&isFinite(e)&&!this.isString&&!this.isBoolean&&!this.isObject&&!this.isArray},isArray:function(e){return!this.isNull(e)&&"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return!this.isEmpty(e)&&"object"==typeof e},isBoolean:function(e){return"boolean"==typeof e},isString:function(e){return"string"==typeof e},isNull:function(e){return void 0===e||null===e},isEmpty:function(e){return this.isNull(e)||void 0!==e.length&&0==e.length}},window.OPTIONS={get:function(e,t,n){var o=void 0===localStorage[e]||"null"==typeof localStorage[e]?HELPER.pack(t):localStorage[e];switch(o=null==HELPER.unpack(o)?t:HELPER.unpack(o),n){case"number":(HELPER.isNull(o)||HELPER.isEmpty(o))&&(o=0),HELPER.isNumber(o)||(o=parseFloat(o)),this.set(e,o);break;case"boolean":o=HELPER.isBoolean(o)?o:!!t,this.set(e,o);break;case"object":case"array":o=HELPER.isObject(o)||HELPER.isArray(o)?o:"array"==n?[]:{},this.set(e,o);break;default:this.set(e,o)}return o},set:function(e,t){t=HELPER.pack(t),localStorage[e]=t}},function(e,t,n){var o=OPTIONS.get("INTERVAL",.1666666666666667,"number"),r=OPTIONS.get("AUDIO_CHECKBOX",!0,"boolean"),i=OPTIONS.get("SOUNDS","/sound/alarm0.ogg","string"),s=OPTIONS.get("AUDIO_VOLUME",.5,"number"),a=OPTIONS.get("TAB_CHECKBOX",!0,"boolean"),c=OPTIONS.get("DEMICOLOR_CHECKBOX",!0,"boolean"),u="https://demiart.ru/forum/",l=null,d=0,g=0,f=0,m=0,p=t.createElement("canvas").getContext("2d"),h=t.createElement("img");p.canvas.width=16,p.canvas.height=16,h.width=16,h.height=16,h.src=e.runtime.getURL("/images/favicon.png");const b="https://demiart.ru/forum/",O=e.runtime.getURL("/images/icon19.png"),T=e.runtime.getURL("/images/fi.png"),E=(e.i18n.getMessage("@@extension_id"),new Audio),I=function(e){clearTimeout(m),m=setTimeout(x,100)},x=async function(){let t=n.navigator.onLine;if(clearTimeout(m),e.browserAction.setIcon({path:O}),o&&t){e.browserAction.setIcon({path:T});let n="https://demiart.ru/forum/index.php?act=ST&CODE=discuss&_="+(new Date).getTime();fetch(n).then(function(n){n.json().then(function(t){t.year=new Date(n.headers.get("date")).getFullYear(),OPTIONS.set("YEAR",t.year),u=t.href,e.browserAction.setIcon({path:O}),e.browserAction.setBadgeText({text:t.count?String(t.count):""}),t.count>d&&r&&(E.volume=parseFloat(s),E.currentTime=0,E.src=e.runtime.getURL(i),E.play()),d=t.count,y()}).catch(function(){u=b,d=0,e.browserAction.setIcon({path:O}),e.browserAction.setBadgeText({text:t?"Error":"Off"}),y()}),e.browserAction.setIcon({path:O}),m=setTimeout(x,6e4*o)}).catch(function(){u=b,d=0,e.browserAction.setIcon({path:O}),e.browserAction.setBadgeText({text:t?"Error":"Off"}),y(),m=setTimeout(x,6e4*o)})}else{let n=o||.1;u=b,d=0,e.browserAction.setIcon({path:O}),e.browserAction.setBadgeText({text:t?"":"Off"}),y(),m=setTimeout(x,6e4*n)}},S=function(){void 0!=l&&a?e.tabs.query({},function(t){for(var n=0;n<t.length;++n){var o=t[n];if(/^(https?:\/\/demiart.ru\/forum)/gi.test(o.url)&&l.id==o.id)return void e.tabs.update(l.id,{url:u,active:!0},v)}e.tabs.create({url:u,active:!0},v)}):e.tabs.create({url:u,active:!0},v)},v=function(e){l=e},M=function(t){e.tabs.insertCSS(t,{file:"/css/messages.css"},function(){}),e.tabs.executeScript(t,{file:"/js/messages.js"},function(){})},y=function(){e.tabs.query({},function(t){for(let n=0;n<t.length;++n){let o=t[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(t[n].url)&&e.tabs.sendMessage(o,{idtab:o,ddc:d,url:u,def:b,favicon:w(),message:"ddc",demicolor:c})}}),g&&e.contextMenus.update(g,{title:d<=0?e.i18n.getMessage("forum"):e.i18n.getMessage("comments").replace("*ddc*",d)})},w=function(){let e=String(d>99?"+99":d)+"";if(p.clearRect(0,0,16,16),p.drawImage(h,0,0,16,16,0,0,16,16),d){var t,o=n.devicePixelRatio||1,r=16-9*o,i=16-(7*o+6*o*(e.length-1))-o,s=t=16*o,a=2*o;p.font="bold "+8*o+"px arial",p.fillStyle=p.strokeStyle="#F03D25",p.lineWidth=1,p.beginPath(),p.moveTo(i+a,r),p.quadraticCurveTo(i,r,i,r+a),p.lineTo(i,s-a),p.quadraticCurveTo(i,s,i+a,s),p.lineTo(t-a,s),p.quadraticCurveTo(t,s,t,s-a),p.lineTo(t,r+a),p.quadraticCurveTo(t,r,t-a,r),p.closePath(),p.fill(),p.beginPath(),p.strokeStyle="rgba(0,0,0,0.3)",p.moveTo(i+a/2,s),p.lineTo(t-a/2,s),p.stroke(),p.fillStyle="#ffffff",p.textAlign="right",p.textBaseline="top",p.fillText(e+"",2===o?29:15,6*o)}return p.canvas.toDataURL()};e.runtime.onMessage.addListener(function(t,n,u){return setTimeout(function(){switch(u({status:!0}),clearTimeout(f),t.message){case"OPTIONS":o=OPTIONS.get("INTERVAL",.16667,"number"),r=OPTIONS.get("AUDIO_CHECKBOX",!0,"boolean"),i=OPTIONS.get("SOUNDS","/sound/alarm0.ogg","string"),s=OPTIONS.get("AUDIO_VOLUME",.5,"number"),a=OPTIONS.get("TAB_CHECKBOX",!0,"boolean"),c=OPTIONS.get("DEMICOLOR_CHECKBOX",!0,"boolean"),f=setTimeout(()=>{E.volume=parseFloat(s),E.currentTime=0,E.src=e.runtime.getURL(i)},1),x(),e.tabs.query({},function(t){for(let n=0;n<t.length;++n){let o=t[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(t[n].url)&&setTimeout(function(){e.tabs.sendMessage(o,{demicolor:c,message:"demicolor"})},100)}});break;case"FETCH":x()}},1),!0}),e.browserAction.onClicked.addListener(function(e){S()}),e.tabs.onUpdated.addListener(function(e,t,n){var o=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi;new RegExp("showuser","ig");switch(t.status){case"loading":o.test(n.url)&&(M(n.id),x())}o=/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi,"loading"==t.status&&o.test(n.url)}),e.tabs.query({},function(t){for(let n=0;n<t.length;++n){let o=t[n].id;/(https?:\/\/demiart.ru\/forum\/(.+.php\?)?)/gi.test(t[n].url)&&(M(t[n].id),setTimeout(function(){e.tabs.sendMessage(o,{idtab:o,url:u,def:b,ddc:d,favicon:w(),demicolor:c,message:"ddc"})},100))}}),e.browserAction.setIcon({path:O}),e.browserAction.setBadgeBackgroundColor({color:"#d22d2d"}),n.addEventListener("online",I),n.addEventListener("offline",I),E.controls=!1,E.style.display="none",E.crossOrigin="anonymous",E.preload="none",E.src=e.runtime.getURL(i),x(),ddcMenu=e.contextMenus.create({title:"Demiart DDC",contexts:["all"]}),g=e.contextMenus.create({title:e.i18n.getMessage("forum"),contexts:["all"],parentId:ddcMenu,onclick:S}),e.contextMenus.create({title:e.i18n.getMessage("hosting"),contexts:["all"],parentId:ddcMenu,onclick:function(){e.tabs.create({url:"https://morgoth.ru/",active:!0},function(e){})}}),e.contextMenus.create({title:e.i18n.getMessage("youtube"),contexts:["all"],parentId:ddcMenu,onclick:function(){e.tabs.create({url:"https://www.youtube.com/c/demiartru",active:!0},function(e){})}}),e.contextMenus.create({title:e.i18n.getMessage("demicolor"),contexts:["all"],parentId:ddcMenu,onclick:function(){e.tabs.create({url:"https://demicolor.demiart.ru/",active:!0},function(e){})}}),e.contextMenus.create({title:"",contexts:["all"],parentId:ddcMenu,type:"separator"}),e.contextMenus.create({title:e.i18n.getMessage("refresh"),contexts:["all"],parentId:ddcMenu,onclick:x}),e.contextMenus.create({title:"",contexts:["all"],parentId:ddcMenu,type:"separator"}),e.contextMenus.create({title:e.i18n.getMessage("settings"),contexts:["all"],parentId:ddcMenu,onclick:function(){e.runtime.openOptionsPage()}}),console.log("%c Demiart DDC && DemiartColor Code ","background:#4C5D55;color:#e7aa11;font-size:40px;")}(chrome,document,window);